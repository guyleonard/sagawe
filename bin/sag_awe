#!/usr/bin/env bash


#
# Program Functions
#


#
# Workflow Functions
#
function help_message () {
    echo -e "Single Amplified Genome Assembly Workflow Example (SAG-AWE)"
    echo -e "Input Options (required):"
    echo -e " -f <r1.fastq|r1.fastq.gz>\tRead Library Pair 1"
    echo -e " -r <r2.fastq|r2.fastq.gz>\tRead Library Pair 2"
    echo -e "Output Options (required):"
    echo -e " -o <output_dir>\tOutput Directory"
    echo -e "Program Parameters:"
    echo -e "Optional Parameters:"
    echo -e "Reports/Stats:"
    echo -e "Example: sag_awe"
    exit 1
}

#
# Accessory Functions
#
function cores () {
    cores=$(grep -c ^processor /proc/cpuinfo 2>/dev/null || sysctl -n hw.ncpu)
    echo $(($cores / 2))
}

function cite_log () {
    absolute_path=${1}
    output_dir=${2}
    echo "Single Amplified Genome Assembly Workflow" > "${absolute_path}/$output_dir.log"
    echo "Please cite:" >> "${absolute_path}/$output_dir.log"
    echo -e "\thttps://github.com/guyleonard/sagawe\n" >> "$absolute_path/$output_dir.log"
    echo -e "\nOutput Dir: $absolute_path" >> "$absolute_path/$output_dir.log"
    echo "Date Run: $(date +%Y-%m-%d)" >> "$absolute_path/$output_dir.log"
    echo "Command: ${0} ${@}" >> "$absolute_path/$output_dir.log"
}

#
# Workflow Variables
#
THREADS=$(cores)
NORMALISED="false"
ASSEMBLY="contigs.fasta"
NUMARGS=$#
if [ "$NUMARGS" -eq 0 ]; then
    help_message
fi

#
# Getopts Workflow
#
while getopts f:r:h FLAG; do
    case ${FLAG} in
        f)
            READ1=${optarg}
	    ;;
        r)
            READ2=${optarg}
            ;;
        o)
            OUTDIR=${optarg}
	    mkdir -p ${OUTDIR}
            absolute_path="$( cd "${OUTDIR}" && pwd )"
            cite_log "${absolute_path}" "${OUTDIR}"
        h)
            help_message
	    ;;
        \?)
            echo -e "Unknown option ${FLAG}."
	    help_message
    esac
done

exit 0
