#!/usr/bin/env bash

#
# Program Functions
#
function run_trim_galore () {
    trimmed_dir="$( cd "${1}" && pwd )/trimmed"

    if [ -d "${trimmed_dir}" ] ; then
        echo "[SAGAWE:WARN] - Adaptor Trimming Previously Run"
        echo "[SAGAWE:INFO] - Skipping to Next Step"
    else
        mkdir -p "${trimmed_dir}"
        fastqc_dir="${trimmed_dir}/fastqc"
        mkdir -p "${fastqc_dir}"

        echo "[SAGAWE:INFO] - Running Trim Galore! on Raw Reads"
        trim_galore -q 20 --fastqc --'gzip' --length 50 --paired --retain_unpaired \
        "${READ1}" "${READ2}" -o "${trimmed_dir}" 2>&1 | tee "${trimmed_dir}/trim_galore.log"

        read1="$(basename "${READ1}")" # get filename
        read1="${read1%%.*}"         # remove extension
        cat "${trimmed_dir}/${read1}_unpaired_1.fq.gz" "${trimmed_dir}/${read1/r1/r2}_unpaired_2.fq.gz" > "${trimmed_dir}/${read1/r1/all}_unpaired.fq.gz"

        mv "${trimmed_dir}/"*".html" "${fastqc_dir}"
        mv "${trimmed_dir}/"*".zip" "${fastqc_dir}"
        mv "${trimmed_dir}/"*".txt" "${fastqc_dir}"
    fi
}

function run_normalisation () {
    trimmed_dir="$( cd "${1}" && pwd )/trimmed"
    normalised_dir="$( cd "${1}" && pwd )/normalised"

    if [ -d "${normalised_dir}" ] ; then
        echo "[SAGAWE:WARN] - Normalisation Previously Run"
        echo "[SAGAWE:INFO] - Skipping to Next Step"
    else
        mkdir -p "${normalised_dir}"

        read1=$(basename "${READ1}") # get filename
        read2=$(basename "${READ2}")

        echo "[SAGAWE:INFO] - Running BBNorm on Trimmed Reads"
        bbnorm.sh \
        in1="${trimmed_dir}/${read1/.fq.gz/_val_1.fq.gz}" \
        in2="${trimmed_dir}/${read2/.fq.gz/_val_2.fq.gz}" \
        out1="${normalised_dir}/${read1/.fq.gz/_normalised.fq.gz}" \
        out2="${normalised_dir}/${read2/.fq.gz/_normalised.fq.gz}" \
        outt="${normalised_dir}/excluded_reads.fq.gz" \
        hist="${normalised_dir}/input_kmer_depth.hist" \
        histout="${normalised_dir}/output_kmer_depth.hist" \
        threads="${THREADS}" 2>&1 | tee "${normalised_dir}/bbnorm.log"
    fi
}

function run_bbmerge () {
    trimmed_dir="$( cd "${1}" && pwd )/trimmed"
    normalised_dir="$( cd "${1}" && pwd )/normalised"
    merged_dir=""

    read1=$(basename "${READ1}")
    read2=$(basename "${READ2}")

    if [ "${NORMALISED}" == "true" ] ; then
        merged_dir="${normalised_dir}/merged"

        if [ -d "${merged_dir}" ] ; then
            echo "[SAGAWE:WARN] - Merging Previously Run"
            echo "[SAGAWE:INFO] - Skipping to Next Step"
        else
            mkdir -p "${merged_dir}"

            echo "[SAGAWE:INFO] - Running BBMerge with Trimmed-Normalised Reads"
            bbmerge.sh \
            in1="${normalised_dir}/${read1/.fq.gz/_normalised.fq.gz}" \
            in2="${normalised_dir}/${read2/.fq.gz/_normalised.fq.gz}" \
            out="${merged_dir}/${read1/r1.fq.gz/normalised_merged.fq.gz}" \
            outu1="${merged_dir}/${read1/.fq.gz/_normalised_unmerged.fq.gz}" \
            outu2="${merged_dir}/${read2/.fq.gz/_normalised_unmerged.fq.gz}" \
            minoverlap=10 ziplevel=9 2>&1 | tee "${merged_dir}/bbmerge.log"
        fi
    else
        merged_dir="${trimmed_dir}/merged"
        if [ -d "${merged_dir}" ] ; then
            echo "[SAGAWE:WARN] - Merging Previously Run"
            echo "[SAGAWE:INFO] - Skipping to Next Step"
        else
            mkdir -p "${merged_dir}"

            echo "[SAGAWE:INFO] - Running BBMerge with Trimmed Reads"
            bbmerge.sh \
            in1="${trimmed_dir}/${read1/.fq.gz/_val_1.fq.gz}" \
            in2="${trimmed_dir}/${read2/.fq.gz/_val_2.fq.gz}" \
            out="${merged_dir}/${read1/r1.fq.gz/merged.fq.gz}" \
            outu1="${merged_dir}/${read1/.fq.gz/_unmerged.fq.gz}" \
            outu2="${merged_dir}/${read2/.fq.gz/_unmerged.fq.gz}" \
            minoverlap=10 ziplevel=9 2>&1 | tee "${merged_dir}/bbmerge.log"
        fi
    fi
}

function run_assembly_spades {
    trimmed_dir="$( cd "${1}" && pwd )/trimmed"
    normalised_dir="$( cd "${1}" && pwd )/normalised"
    assembly_dir="$( cd "${1}" && pwd )/assembly"

    read1=$(basename "${READ1}")
    read2=$(basename "${READ2}")

    if [[ "${MERGED}" == "true" && "${NORMALISED}" == "true" ]] ; then
        merged_dir="${normalised_dir}/merged"
        assembly_dir="${assembly_dir}/tnm"

        if [ -d "${assembly_dir}" ] ; then
            echo "[SAGAWE:WARN] - TNM Assembly Previously Run"
            echo "[SAGAWE:INFO] - Skipping to Next Step"
        else
            echo "[SAGAWE:INFO] - Running Assembly with Trimmed-Normalised-Merged Reads"
            mkdir -p "${assembly_dir}"

            spades.py --sc --careful -t "$THREADS" \
            --pe1-m "${merged_dir}/${read1/r1.fq.gz/normalised_merged.fq.gz}" \
            --pe1-1 "${merged_dir}/${read1/.fq.gz/_normalised_unmerged.fq.gz}" \
            --pe1-2 "${merged_dir}/${read2/.fq.gz/_normalised_unmerged.fq.gz}" \
            -o "$assembly_dir"
         fi
    elif [[ "${MERGED}" == "true" && "${NORMALISED}" == "false" ]] ; then
        merged_dir="${trimmed_dir}/merged"
        assembly_dir="${assembly_dir}/tm"
        if [ -d "${assembly_dir}" ] ; then
            echo "[SAGAWE:WARN] - TM Assembly Previously Run"
            echo "[SAGAWE:INFO] - Skipping to Next Step"
        else
            echo "[SAGAWE:INFO] - Running Assembly with Trimmed-Merged Reads"
            mkdir -p "${assembly_dir}"

            spades.py --sc --careful -t "$THREADS" \
            --pe1-m "${merged_dir}/${read1/r1.fq.gz/merged.fq.gz}" \
            --pe1-1 "${merged_dir}/${read1/.fq.gz/_unmerged.fq.gz}" \
            --pe1-2 "${merged_dir}/${read2/.fq.gz/_unmerged.fq.gz}" \
            -o "$assembly_dir"
        fi
    elif [[ "${MERGED}" == "false" && "${NORMALISED}" == "true" ]] ; then
        assembly_dir="${assembly_dir}/tn"
        if [ -d "${assembly_dir}" ] ; then
            echo "[SAGAWE:WARN] - TN Assembly Previously Run"
            echo "[SAGAWE:INFO] - Skipping to Next Step"
        else
            echo "[SAGAWE:INFO] - Running Assembly with Trimmed-Normalised Reads"
            mkdir -p "${assembly_dir}"

            spades.py --sc --careful -t "$THREADS" \
            --pe1-1 "${normalised_dir}/${read1/.fq.gz/_normalised.fq.gz}" \
            --pe1-2 "${normalised_dir}/${read2/.fq.gz/_normalised.fq.gz}" \
            -o "$assembly_dir"
        fi
    else
        assembly_dir="${assembly_dir}/t"
        if [ -d "${assembly_dir}" ] ; then
            echo "[SAGAWE:WARN] - T Assembly Previously Run"
            echo "[SAGAWE:INFO] - Skipping to Next Step"
        else
            echo "[SAGAWE:INFO] - Running Assembly with Trimmed Reads"
            mkdir -p "${assembly_dir}"

            spades.py --sc --careful -t "$THREADS" \
            --pe1-1 "${trimmed_dir}/${read1/.fq.gz/_val_1.fq.gz}" \
            --pe1-2 "${trimmed_dir}/${read2/.fq.gz/_val_2.fq.gz}" \
            --pe1-s "${trimmed_dir}/${read1/r1.fq.gz/all_unpaired.fq.gz}" \
            -o "$assembly_dir"
        fi
    fi
}

#
# Report Functions
#
function report_quast_v4 () {
    assembly_dir="$( cd "${1}" && pwd )/assembly"
    quast_dir="$( cd "${1}" && pwd )/reports/quast"

    read1=$(basename "${READ1}")
    read2=$(basename "${READ2}")

    assembly_type="${2}"

    echo "[SAGAWE:INFO] - Running QUAST on ${assembly_type} Assembly with ${ASSEMBLY}"

    quast_dir="${quast_dir}/${assembly_type}"
    mkdir -p "${quast_dir}"

    quast.py -o "${quast_dir}" -t "$THREADS" \
    --glimmer --min-contig 100 --eukaryote "$QUAST_SCAFFOLDS" \
    "${assembly_dir}/${assembly_type}/$ASSEMBLY" 2>&1 | tee "${quast_dir}/quast.log"
}

function report_busco_v3 () {
    assembly_dir="$( cd "${1}" && pwd )/assembly"
    busco_dir="$( cd "${1}" && pwd )/reports/busco"

    assembly_type="${2}"

    busco_dir="${busco_dir}/${assembly_type}"
    mkdir -p "${busco_dir}/summaries"

    IFS=\, read -r -a current_db <<<"${BUSCO_LINEAGES}"
    for lineage in "${current_db[@]}";do
        echo "[SAGAWE:INFO] - Running BUSCO on ${assembly_type} Assembly with ${ASSEMBLY} and ${lineage}"

        lineage_name="$(basename "${lineage}")"
        run_BUSCO.py -i "${assembly_dir}/${assembly_type}/${ASSEMBLY}" \
        -c 24 -o "${lineage_name}" -m genome \
        -l "${lineage}" 2>&1 | tee "${busco_dir}/busco.log"

        mv "run_${lineage_name}" "${busco_dir}"
        ln -s "${busco_dir}/run_${lineage_name}/short_summary_${lineage_name}.txt" "${busco_dir}/summaries"
    done

    generate_plot.py -wd "${busco_dir}/summaries"
}

function report_blobtools () {
    outdir="$( cd "${1}" && pwd )"
    assembly_type="${2}"

    report_blobtools_mapping "${outdir}" "${assembly_type}"
}

function report_blobtools_mapping () {
    trimmed_dir="$( cd "${1}" && pwd )/trimmed"
    assembly_dir="$( cd "${1}" && pwd )/assembly"
    blobtools_dir="$( cd "${1}" && pwd )/reports/blobtools"

    assembly_type="${2}"

    read1=$(basename "${READ1}")
    read2=$(basename "${READ2}")

    mapping_dir="${blobtools_dir}/${assembly_type}/mapping"
    mkdir -p "${mapping_dir}"
    ln -s "${assembly_dir}/${assembly_type}/$ASSEMBLY" "${mapping_dir}/$ASSEMBLY"

    echo "[SAGAWE:INFO] - Indexing Assembly"
    bwa index -a bwtsw "${mapping_dir}/$ASSEMBLY" 2>&1 | tee "${mapping_dir}/bwa.log"

    echo "[SAGAWE:INFO] - Mapping Trimmed Paired Reads to ${ASSEMBLY}"
    bwa mem -t "$THREADS" "${mapping_dir}/$ASSEMBLY" \
    "${trimmed_dir}/${read1/.fq.gz/_val_1.fq.gz}" \
    "${trimmed_dir}/${read2/.fq.gz/_val_2.fq.gz}" \
    > "${mapping_dir}/${ASSEMBLY/.fasta/}_mapped_paired_reads.sam"

    echo "[SAGAWE:INFO] - Mapping Trimmed Un-Paired Reads to ${ASSEMBLY}"
    bwa mem -t "$THREADS" "${mapping_dir}/$ASSEMBLY" \
    "${trimmed_dir}/${read1/r1.fq.gz/all_unpaired.fq.gz}" \
    > "${mapping_dir}/${ASSEMBLY/.fasta/}_mapped_unpaired_reads.sam"

    echo "[SAGAWE:INFO] - Sorting Paired SAM File and Converting to BAM"
    samtools sort -@ "$THREADS" -o "${mapping_dir}/${ASSEMBLY/.fasta/}_mapped_paired_reads.bam" \
    "${mapping_dir}/${ASSEMBLY/.fasta/}_mapped_paired_reads.sam"

    echo "[SAGAWE:INFO] - Sorting Un-Paired SAM File and Converting to BAM"
    samtools sort -@ "$THREADS" -o "${mapping_dir}/${ASSEMBLY/.fasta/}_mapped_unpaired_reads.bam" \
    "${mapping_dir}/${ASSEMBLY/.fasta/}_mapped_unpaired_reads.sam"

    echo "[SAGAWE:INFO] - Merging BAM Files"
    samtools merge -@ "$THREADS" -f "${mapping_dir}/${ASSEMBLY/.fasta/}_mapped_all_reads.bam" \
    "${mapping_dir}/${ASSEMBLY/.fasta/}_mapped_paired_reads.bam" \
    "${mapping_dir}/${ASSEMBLY/.fasta/}_mapped_unpaired_reads.bam"

    echo "[SAGAWE:INFO] - Indexing Bam"
    samtools index "${mapping_dir}/${ASSEMBLY/.fasta/}_mapped_all_reads.bam"

    rm "${mapping_dir}/${ASSEMBLY/.fasta/}_mapped_paired_reads.sam"
    rm "${mapping_dir}/${ASSEMBLY/.fasta/}_mapped_unpaired_reads.sam"
}

#
# Accessory Functions
#
function get_assembly_type () {
    local assembly_type=""

    if [[ "${MERGED}" == "true" && "${NORMALISED}" == "true" ]] ; then
        assembly_type="tnm"
    elif [[ "${MERGED}" == "true" && "${NORMALISED}" == "false" ]] ; then
        assembly_type="tm"
    elif [[ "${MERGED}" == "false" && "${NORMALISED}" == "true" ]] ; then
        assembly_type="tn"
    else
        assembly_type="t"
    fi
    echo "${assembly_type}"
}

function help_message () {
    echo -e "Single Amplified Genome Assembly Workflow Example (SAG-AWE)"
    echo -e "\tOptions are positional, i.e. they are run sequentially"
    echo -e "Input Options (required):"
    echo -e "\t-f <r1.fq|r1.fq.gz>\tRead Library Pair 1"
    echo -e "\t-r <r2.fq|r2.fq.gz>\tRead Library Pair 2"
    echo -e "Output Options (required):"
    echo -e "\t-o <output_dir>\tOutput Directory"
    echo -e "Program Parameters:"
    echo -e "\t-t\tRun Trim Galore!"
    echo -e "\t-n\tRun Normalisation"
    echo -e "\t-m\tRun Read Merging"
    echo -e "\t-s\tRun Assembly"
    echo -e "Optional Parameters:"
    echo -e "\t-S\tUse scaffolds.fasta instead of contigs.fasta"
    echo -e "Reports/Stats:"
    echo -e "\t-q\tRun Quast"
    echo -e "\t-b </path/to/db1,/path/to/db2,...>\tRun BUSCO with Multiple Lineages"
    echo -e "Example: sag_awe"
    exit 1
}

function cores () {
    cores=$(grep -c ^processor /proc/cpuinfo 2>/dev/null || sysctl -n hw.ncpu)
    echo $((cores / 2))
}

function cite_log () {
    absolute_path=${1}
    output_dir=${2}
    echo -e "Single Amplified Genome Assembly Workflow" > "${absolute_path}/$output_dir.log"
    echo -e "Please cite:\thttps://github.com/guyleonard/sagawe\n" >> "$absolute_path/$output_dir.log"
    echo -e "Output Dir:\t$absolute_path" >> "$absolute_path/$output_dir.log"
    echo -e "Date Started:\t$(date +%Y-%m-%d-%R)" >> "$absolute_path/$output_dir.log"
    echo -e "Location:\t$HOSTNAME" >> "$absolute_path/$output_dir.log"
    echo -e "Command:\t${0} ${ARGS}" >> "$absolute_path/$output_dir.log"
    echo -e "Individual logs for each step are located in their respective folder." >> "$absolute_path/$output_dir.log"
}

#
# Workflow Variables
#
ARGS=( "$@" )
ASSEMBLY="contigs.fasta"
BUSCO_LINEAGES="eukaryota_odb9"
MERGED="false"
NORMALISED="false"
NUMARGS=$#
OUTDIR="output_sagawe"
QUAST_SCAFFOLDS=""
READ1=""
READ2=""
THREADS=$(cores)
if [ "${NUMARGS}" -eq 0 ]; then
    help_message
fi

#
# Getopts Workflow
#
while getopts "f:r:o:tnmsqSb:Bh" FLAG; do
    case ${FLAG} in
        f)
            READ1=${OPTARG}
	    ;;
        r)
            READ2=${OPTARG}
            ;;
        o)
            OUTDIR=${OPTARG}
	    mkdir -p "${OUTDIR}"
            absolute_path="$( cd "${OUTDIR}" && pwd )"
            cite_log "${absolute_path}" "${OUTDIR}"
            ;;
        t)
            run_trim_galore "${OUTDIR}"
            ;;
        n)
            run_normalisation "${OUTDIR}"
            NORMALISED="true"
            ;;
        m)
            run_bbmerge "${OUTDIR}"
            MERGED="true"
            ;;
        s)
            run_assembly_spades "${OUTDIR}"
            ;;
        q)
            assembly_type=$(get_assembly_type)
            report_quast_v4 "${OUTDIR}" "${assembly_type}"
            ;;
        S)
            ASSEMBLY="scaffolds.fasta"
            QUAST_SCAFFOLDS="-s"
            ;;
        b)
            BUSCO_LINEAGES="${OPTARG}"
            assembly_type=$(get_assembly_type)
            report_busco_v3 "${OUTDIR}" "${assembly_type}"
            ;;
        B)
            assembly_type=$(get_assembly_type)
            report_blobtools "${OUTDIR}" "${assembly_type}"
            ;;
        h)
            help_message
	    ;;
        \?)
	    help_message
            ;;
    esac
done

if [ ! "${OUTDIR}" ]; then
    echo "No output directory set. Please indicate -o" >&2
    exit 1
fi

absolute_path="$( cd "${OUTDIR}" && pwd )"
echo -e "Date Finished:\t$(date +%Y-%m-%d-%R)" >> "$absolute_path/$output_dir.log"
exit 0

