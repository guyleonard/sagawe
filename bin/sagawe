#!/usr/bin/env bash

#
# Program Functions
#
function run_trim_galore () {
    trimmed_dir="$( cd "${1}" && pwd )/trimmed"

    if [ -d "${trimmed_dir}" ] ; then
        echo "[SAGAWE:WARN] - Adaptor Trimming Previously Run"
        echo "[SAGAWE:INFO] - Skipping to Next Step"
    else
        mkdir -p "${trimmed_dir}"
        fastqc_dir="${trimmed_dir}/fastqc"
        mkdir -p "${fastqc_dir}"

        echo "[SAGAWE:INFO] - Running Trim Galore! on Raw Reads"
        trim_galore -q 20 --fastqc --'gzip' --length 50 --paired --retain_unpaired \
        "${READ1}" "${READ2}" -o "${trimmed_dir}" 2>&1 | tee "${trimmed_dir}/sag_awe_trim_galore.log"

        read1="$(basename "${READ1}")"
        read2="$(basename "${READ2}")"

        cat "${trimmed_dir}/${read1/.fq.gz/_unpaired_1.fq.gz}" "${trimmed_dir}/${read2/.fq.gz/_unpaired_2.fq.gz}" > "${trimmed_dir}/unpaired_all.fq.gz"

        mv "${trimmed_dir}/"*".html" "${fastqc_dir}"
        mv "${trimmed_dir}/"*".zip" "${fastqc_dir}"
        mv "${trimmed_dir}/"*".txt" "${fastqc_dir}"
    fi
}

function run_normalisation () {
    trimmed_dir="$( cd "${1}" && pwd )/trimmed"
    normalised_dir="$( cd "${1}" && pwd )/normalised"

    if [ -d "${normalised_dir}" ] ; then
        echo "[SAGAWE:WARN] - Normalisation Previously Run"
        echo "[SAGAWE:INFO] - Skipping to Next Step"
    else
        mkdir -p "${normalised_dir}"

        read1=$(basename "${READ1}")
        read2=$(basename "${READ2}")

        echo "[SAGAWE:INFO] - Running BBNorm on Trimmed Reads"
        bbnorm.sh \
        in1="${trimmed_dir}/${read1/.fq.gz/_val_1.fq.gz}" \
        in2="${trimmed_dir}/${read2/.fq.gz/_val_2.fq.gz}" \
        out1="${normalised_dir}/${read1/.fq.gz/_normalised.fq.gz}" \
        out2="${normalised_dir}/${read2/.fq.gz/_normalised.fq.gz}" \
        outt="${normalised_dir}/excluded_reads.fq.gz" \
        hist="${normalised_dir}/input_kmer_depth.hist" \
        histout="${normalised_dir}/output_kmer_depth.hist" \
        threads="${THREADS}" 2>&1 | tee "${normalised_dir}/sag_awe_bbnorm.log"
    fi
}

function run_bbmerge () {
    trimmed_dir="$( cd "${1}" && pwd )/trimmed"
    normalised_dir="$( cd "${1}" && pwd )/normalised"
    merged_dir=""

    read1=$(basename "${READ1}")
    read2=$(basename "${READ2}")

    if [ "${NORMALISED}" == "true" ] ; then
        merged_dir="${normalised_dir}/merged"

        if [ -d "${merged_dir}" ] ; then
            echo "[SAGAWE:WARN] - Merging Previously Run"
            echo "[SAGAWE:INFO] - Skipping to Next Step"
        else
            mkdir -p "${merged_dir}"

            echo "[SAGAWE:INFO] - Running BBMerge with Trimmed-Normalised Reads"
            bbmerge.sh \
            in1="${normalised_dir}/${read1/.fq.gz/_normalised.fq.gz}" \
            in2="${normalised_dir}/${read2/.fq.gz/_normalised.fq.gz}" \
            out="${merged_dir}/${read1/r1.fq.gz/normalised_merged.fq.gz}" \
            outu1="${merged_dir}/${read1/.fq.gz/_normalised_unmerged.fq.gz}" \
            outu2="${merged_dir}/${read2/.fq.gz/_normalised_unmerged.fq.gz}" \
            minoverlap=10 ziplevel=9 2>&1 | tee "${merged_dir}/sag_awe_bbmerge.log"
        fi
    else
        merged_dir="${trimmed_dir}/merged"
        if [ -d "${merged_dir}" ] ; then
            echo "[SAGAWE:WARN] - Merging Previously Run"
            echo "[SAGAWE:INFO] - Skipping to Next Step"
        else
            mkdir -p "${merged_dir}"

            echo "[SAGAWE:INFO] - Running BBMerge with Trimmed Reads"
            bbmerge.sh \
            in1="${trimmed_dir}/${read1/.fq.gz/_val_1.fq.gz}" \
            in2="${trimmed_dir}/${read2/.fq.gz/_val_2.fq.gz}" \
            out="${merged_dir}/${read1/r1.fq.gz/merged.fq.gz}" \
            outu1="${merged_dir}/${read1/.fq.gz/_unmerged.fq.gz}" \
            outu2="${merged_dir}/${read2/.fq.gz/_unmerged.fq.gz}" \
            minoverlap=10 ziplevel=9 2>&1 | tee "${merged_dir}/sag_awe_bbmerge.log"
        fi
    fi
}

function run_assembly_spades {
    trimmed_dir="$( cd "${1}" && pwd )/trimmed"
    normalised_dir="$( cd "${1}" && pwd )/normalised"
    assembly_dir="$( cd "${1}" && pwd )/assembly"

    read1=$(basename "${READ1}")
    read2=$(basename "${READ2}")

    if [[ "${MERGED}" == "true" && "${NORMALISED}" == "true" ]] ; then
        merged_dir="${normalised_dir}/merged"
        assembly_dir="${assembly_dir}/tnm"

        if [ -d "${assembly_dir}" ] ; then
            echo "[SAGAWE:WARN] - TNM Assembly Previously Run"
            echo "[SAGAWE:INFO] - Skipping to Next Step"
        else
            echo "[SAGAWE:INFO] - Running Assembly with Trimmed-Normalised-Merged Reads"
            mkdir -p "${assembly_dir}"

            spades.py --sc --careful -t "$THREADS" \
            --pe1-m "${merged_dir}/${read1/r1.fq.gz/normalised_merged.fq.gz}" \
            --pe1-1 "${merged_dir}/${read1/.fq.gz/_normalised_unmerged.fq.gz}" \
            --pe1-2 "${merged_dir}/${read2/.fq.gz/_normalised_unmerged.fq.gz}" \
            -o "$assembly_dir"
         fi
    elif [[ "${MERGED}" == "true" && "${NORMALISED}" == "false" ]] ; then
        merged_dir="${trimmed_dir}/merged"
        assembly_dir="${assembly_dir}/tm"
        if [ -d "${assembly_dir}" ] ; then
            echo "[SAGAWE:WARN] - TM Assembly Previously Run"
            echo "[SAGAWE:INFO] - Skipping to Next Step"
        else
            echo "[SAGAWE:INFO] - Running Assembly with Trimmed-Merged Reads"
            mkdir -p "${assembly_dir}"

            spades.py --sc --careful -t "$THREADS" \
            --pe1-m "${merged_dir}/${read1/r1.fq.gz/merged.fq.gz}" \
            --pe1-1 "${merged_dir}/${read1/.fq.gz/_unmerged.fq.gz}" \
            --pe1-2 "${merged_dir}/${read2/.fq.gz/_unmerged.fq.gz}" \
            -o "$assembly_dir"
        fi
    elif [[ "${MERGED}" == "false" && "${NORMALISED}" == "true" ]] ; then
        assembly_dir="${assembly_dir}/tn"
        if [ -d "${assembly_dir}" ] ; then
            echo "[SAGAWE:WARN] - TN Assembly Previously Run"
            echo "[SAGAWE:INFO] - Skipping to Next Step"
        else
            echo "[SAGAWE:INFO] - Running Assembly with Trimmed-Normalised Reads"
            mkdir -p "${assembly_dir}"

            spades.py --sc --careful -t "$THREADS" \
            --pe1-1 "${normalised_dir}/${read1/.fq.gz/_normalised.fq.gz}" \
            --pe1-2 "${normalised_dir}/${read2/.fq.gz/_normalised.fq.gz}" \
            -o "$assembly_dir"
        fi
    else
        assembly_dir="${assembly_dir}/t"
        if [ -d "${assembly_dir}" ] ; then
            echo "[SAGAWE:WARN] - T Assembly Previously Run"
            echo "[SAGAWE:INFO] - Skipping to Next Step"
        else
            echo "[SAGAWE:INFO] - Running Assembly with Trimmed Reads"
            mkdir -p "${assembly_dir}"

            spades.py --sc --careful -t "$THREADS" \
            --pe1-1 "${trimmed_dir}/${read1/.fq.gz/_val_1.fq.gz}" \
            --pe1-2 "${trimmed_dir}/${read2/.fq.gz/_val_2.fq.gz}" \
            --pe1-s "${trimmed_dir}/${read1/r1.fq.gz/all_unpaired.fq.gz}" \
            -o "$assembly_dir"
        fi
    fi
}

#
# Report Functions
#
function report_quast_v4 () {
    assembly_dir="$( cd "${1}" && pwd )/assembly"
    quast_dir="$( cd "${1}" && pwd )/reports/quast"

    assembly_type="${2}"

    echo "[SAGAWE:INFO] - Running QUAST on ${assembly_type} Assembly with ${ASSEMBLY}"

    quast_dir="${quast_dir}/${assembly_type}"
    mkdir -p "${quast_dir}"

    quast.py -o "${quast_dir}" -t "${THREADS}" --glimmer --min-contig 100 ${QUAST_SCAFFOLDS} --eukaryote \
    "${assembly_dir}/${assembly_type}/${ASSEMBLY}" 2>&1 | tee "${quast_dir}/sag_awe_quast.log"
}

function report_busco_v3 () {
    assembly_dir="$( cd "${1}" && pwd )/assembly"
    busco_dir="$( cd "${1}" && pwd )/reports/busco"

    assembly_type="${2}"

    busco_dir="${busco_dir}/${assembly_type}"
    mkdir -p "${busco_dir}/summaries"

    IFS=\, read -r -a current_db <<<"${BUSCO_LINEAGES}"
    for lineage in "${current_db[@]}";do
        echo "[SAGAWE:INFO] - Running BUSCO on ${assembly_type} Assembly with ${ASSEMBLY} and ${lineage}"

        lineage_name="$(basename "${lineage}")"
        run_BUSCO.py -i "${assembly_dir}/${assembly_type}/${ASSEMBLY}" \
        -c 24 -o "${lineage_name}" -m genome \
        -l "${lineage}" 2>&1 | tee "${busco_dir}/sag_awe_busco.log"

        mv "run_${lineage_name}" "${busco_dir}"
        ln -s "${busco_dir}/run_${lineage_name}/short_summary_${lineage_name}.txt" "${busco_dir}/summaries"
    done

    generate_plot.py -wd "${busco_dir}/summaries"
}

function report_cegma () {
    assembly_dir="$( cd "${1}" && pwd )/assembly"

    assembly_type="${2}"

    cegma_dir="$( cd "${1}" && pwd )/reports/cegma/${assembly_type}"

    if [ ! -f "${assembly_dir}/${assembly_type}/${ASSEMBLY}" ] ; then
        echo -e "[SAGAWE:ERROR] - SPAdes ${ASSEMBLY} cannot be found. Aborting."
        exit 1
    else
        mkdir -p "$cegma_dir"

        echo "[SAGAWE:INFO] - Running CEGMA on ${assembly_type} with ${ASSEMBLY}"
        cegma -T "${THREADS}" -g "${assembly_dir}/${assembly_type}/${ASSEMBLY}" -o "${cegma_dir}/cegma" 2>&1 | tee "${cegma_dir}/sag_awe_cegma.log"

        mv "${cegma_dir}/cegma."* "${cegma_dir}"
    fi
}


function report_blobtools () {
    outdir="$( cd "${1}" && pwd )"
    assembly_type="${2}"

    report_blobtools_mapping "${outdir}" "${assembly_type}"
    report_blobtools_blast "${outdir}" "${assembly_type}"
    report_blobtools_output "${outdir}" "${assembly_type}"
}

function report_blobtools_mapping () {
    trimmed_dir="$( cd "${1}" && pwd )/trimmed"
    assembly_dir="$( cd "${1}" && pwd )/assembly"
    blobtools_dir="$( cd "${1}" && pwd )/reports/blobtools"

    assembly_type="${2}"

    read1=$(basename "${READ1}")
    read2=$(basename "${READ2}")

    mapping_dir="${blobtools_dir}/${assembly_type}/mapping"
    mkdir -p "${mapping_dir}"
    ln -s "${assembly_dir}/${assembly_type}/${ASSEMBLY}" "${mapping_dir}/${ASSEMBLY}"

    echo "[SAGAWE:INFO] - Indexing $assembly_type Assembly with ${ASSEMBLY}"
    bwa index -a bwtsw "${mapping_dir}/${ASSEMBLY}" 2>&1 | tee "${mapping_dir}/bwa.log"

    echo "[SAGAWE:INFO] - Mapping Trimmed Paired Reads to ${ASSEMBLY}"
    bwa mem -t "$THREADS" "${mapping_dir}/${ASSEMBLY}" \
    "${trimmed_dir}/${read1/.fq.gz/_val_1.fq.gz}" \
    "${trimmed_dir}/${read2/.fq.gz/_val_2.fq.gz}" \
    > "${mapping_dir}/${ASSEMBLY/.fasta/}_mapped_paired_reads.sam"

    echo "[SAGAWE:INFO] - Mapping Trimmed Un-Paired Reads to ${ASSEMBLY}"
    bwa mem -t "$THREADS" "${mapping_dir}/${ASSEMBLY}" \
    "${trimmed_dir}/${read1/r1.fq.gz/all_unpaired.fq.gz}" \
    > "${mapping_dir}/${ASSEMBLY/.fasta/}_mapped_unpaired_reads.sam"

    echo "[SAGAWE:INFO] - Sorting Paired SAM File and Converting to BAM"
    samtools sort -@ "$THREADS" -o "${mapping_dir}/${ASSEMBLY/.fasta/}_mapped_paired_reads.bam" \
    "${mapping_dir}/${ASSEMBLY/.fasta/}_mapped_paired_reads.sam"

    echo "[SAGAWE:INFO] - Sorting Un-Paired SAM Files and Converting to BAM"
    samtools sort -@ "$THREADS" -o "${mapping_dir}/${ASSEMBLY/.fasta/}_mapped_unpaired_reads.bam" \
    "${mapping_dir}/${ASSEMBLY/.fasta/}_mapped_unpaired_reads.sam"

    echo "[SAGAWE:INFO] - Merging BAM Files"
    samtools merge -@ "$THREADS" -f "${mapping_dir}/${ASSEMBLY/.fasta/}_mapped_all_reads.bam" \
    "${mapping_dir}/${ASSEMBLY/.fasta/}_mapped_paired_reads.bam" \
    "${mapping_dir}/${ASSEMBLY/.fasta/}_mapped_unpaired_reads.bam"

    echo "[SAGAWE:INFO] - Indexing Bam"
    samtools index "${mapping_dir}/${ASSEMBLY/.fasta/}_mapped_all_reads.bam"

    rm "${mapping_dir}/${ASSEMBLY/.fasta/}_mapped_paired_reads.sam"
    rm "${mapping_dir}/${ASSEMBLY/.fasta/}_mapped_unpaired_reads.sam"
}

function report_blobtools_blast {
    assembly_dir="$( cd "${1}" && pwd )/assembly"
    blobtools_dir="$( cd "${1}" && pwd )/reports/blobtools"

    assembly_type="${2}"

    blast_dir="${blobtools_dir}/${assembly_type}/blast"
    mkdir -p "${blast_dir}"
    ln -s "${assembly_dir}/${assembly_type}/$ASSEMBLY" "${blast_dir}/${ASSEMBLY}"

    echo "[SAGAWE:INFO] - Running megaBLAST on $assembly_type Assembly with ${ASSEMBLY}"

    if [ -f "${blast_dir}/${ASSEMBLY/.fasta/}_vs_$(basename "${NCBI_DB}")_1e-10.megablast" ]; then
        echo "[SAGAWE:WARNING] - MEGABLAST already run! Skipping"
    else
        blastn -task megablast -query "${blast_dir}/${ASSEMBLY}" -db "${NCBI_DB}" \
        -evalue 1e-10 -num_threads "${THREADS}" \
        -outfmt '6 qseqid staxids bitscore std sscinames sskingdoms stitle' \
        -culling_limit 5 -out "${blast_dir}/${ASSEMBLY/.fasta/}_vs_$(basename "${NCBI_DB}")_1e-10.megablast" \
        2>&1 | tee "${blast_dir}/sag_awe_blast.log"
    fi
}

function report_blobtools_output {
    blobtools_dir="$( cd "${1}" && pwd )/reports/blobtools"
    assembly_type="${2}"

    mapping_dir="${blobtools_dir}/${assembly_type}/mapping"
    blast_dir="${blobtools_dir}/${assembly_type}/blast"
    table_dir="${blobtools_dir}/${assembly_type}/tables"
    image_dir="${blobtools_dir}/${assembly_type}/images"
    mkdir -p "${table_dir}"
    mkdir -p "${image_dir}"

    echo "[SAGAWE:INFO] - Running BlobTools CREATE"
    blobtools create -i "${blast_dir}/${ASSEMBLY}" \
    --nodes "/storage/databases/ncbi/taxdump/03-08-2018/nodes.dmp" --names "/storage/databases/ncbi/taxdump/03-08-2018/names.dmp" \
    -t "${blast_dir}/${ASSEMBLY/.fasta/}_vs_$(basename "${NCBI_DB}")_1e-10.megablast" \
    -b "${mapping_dir}/${ASSEMBLY/.fasta/}_mapped_all_reads.bam" \
    -o "${blobtools_dir}/${assembly_type}/${ASSEMBLY/.fasta/}_vs_nt_1e-10_megablast_blobtools" 2>&1 | tee -a "$blobtools_dir/${assembly_type}/sag_awe_blobtools.log"

    echo "[SAGAWE:INFO] - Running BlobTools View - Phylum"
    blobtools view -i "${blobtools_dir}/${assembly_type}/${ASSEMBLY/.fasta/}_vs_nt_1e-10_megablast_blobtools.blobDB.json" \
    --out "${table_dir}/phylum" \
    --rank "phylum" 2>&1 | tee -a "$blobtools_dir/${assembly_type}/sag_awe_blobtools.log"

    echo "[SAGAWE:INFO] - Running BlobTools View - Super Kingdom"
    blobtools view -i "${blobtools_dir}/${assembly_type}/${ASSEMBLY/.fasta/}_vs_nt_1e-10_megablast_blobtools.blobDB.json" \
    --out "${table_dir}/superkingdom" \
    --rank "superkingdom" 2>&1 | tee -a "$blobtools_dir/${assembly_type}/sag_awe_blobtools.log"

    echo "[SAGAWE:INFO] - Running BlobTools Plot PNG - Phylum"
    blobtools plot -i "${blobtools_dir}/${assembly_type}/${ASSEMBLY/.fasta/}_vs_nt_1e-10_megablast_blobtools.blobDB.json" \
    --rank "phylum" --out "${table_dir}/" 2>&1 | tee -a "$blobtools_dir/${assembly_type}/sag_awe_blobtools.log"

    echo "[SAGAWE:INFO] - Running BlobTools Plot PNG - Phylum"
    blobtools plot -i "${blobtools_dir}/${assembly_type}/${ASSEMBLY/.fasta/}_vs_nt_1e-10_megablast_blobtools.blobDB.json" \
    --rank "superkingdom" --out "${image_dir}/" 2>&1 | tee -a "$blobtools_dir/${assembly_type}/sag_awe_blobtools.log"

    echo "[SAGAWE:INFO] - Running BlobTools Plot SVG - Phylum"
    blobtools plot -i "${blobtools_dir}/${assembly_type}/${ASSEMBLY/.fasta/}_vs_nt_1e-10_megablast_blobtools.blobDB.json" \
    --rank "phylum" --format "svg" --out "${table_dir}/" 2>&1 | tee -a "$blobtools_dir/${assembly_type}/sag_awe_blobtools.log"

    echo "[SAGAWE:INFO] - Running BlobTools Plot SVG - Phylum"
    blobtools plot -i "${blobtools_dir}/${assembly_type}/${ASSEMBLY/.fasta/}_vs_nt_1e-10_megablast_blobtools.blobDB.json" \
    --rank "superkingdom" --format "svg" --out "${image_dir}/" 2>&1 | tee -a "$blobtools_dir/${assembly_type}/sag_awe_blobtools.log"
}

#
# Accessory Functions
#
function get_assembly_type () {
    local assembly_type=""

    if [[ "${MERGED}" == "true" && "${NORMALISED}" == "true" ]] ; then
        assembly_type="tnm"
    elif [[ "${MERGED}" == "true" && "${NORMALISED}" == "false" ]] ; then
        assembly_type="tm"
    elif [[ "${MERGED}" == "false" && "${NORMALISED}" == "true" ]] ; then
        assembly_type="tn"
    else
        assembly_type="t"
    fi
    echo "${assembly_type}"
}

function help_message () {
    echo -e "Single Amplified Genome Assembly Workflow Example (SAG-AWE)"
    echo -e "\tOptions are positional, i.e. they are run sequentially, e.g. -S must come before -q."
    echo -e "Input Options (required):"
    echo -e "\t-f <r1.fq|r1.fq.gz>\tRead Library Pair 1"
    echo -e "\t-r <r2.fq|r2.fq.gz>\tRead Library Pair 2"
    echo -e "Output Options (required):"
    echo -e "\t-o <output_dir>\tOutput Directory"
    echo -e "Program Parameters:"
    echo -e "\t-t\tRun Trim Galore!"
    echo -e "\t-n\tRun Normalisation"
    echo -e "\t-m\tRun Read Merging"
    echo -e "\t-s\tRun Assembly"
    echo -e "Optional Parameters:"
    echo -e "\t-S\tUse scaffolds.fasta instead of contigs.fasta"
    echo -e "Reports/Stats:"
    echo -e "\t-q\tRun Quast"
    echo -e "\t-b </path/to/db1,/path/to/db2,...>\tRun BUSCO with Multiple Lineages"
    echo -e "\t-B </path/to/blast/db>\tRun Blobtools"
    echo -e "Example: sag_awe -f read1.fq.gz -r read2.fq.gz -o results -t -n -m -s"
    exit 1
}

function cores () {
    cores=$(grep -c ^processor /proc/cpuinfo 2>/dev/null || sysctl -n hw.ncpu)
    echo $((cores / 2))
}

function cite_log () {
    output_dir="$( cd "${1}" && pwd )"
    echo -e "Single Amplified Genome Assembly Workflow" > "${output_dir}/sag_awe.log"
    echo -e "Please cite:\thttps://github.com/guyleonard/sagawe\n" >> "${output_dir}/sag_awe.log"
    echo -e "Output Dir:\t${output_dir}" >> "${output_dir}/sag_awe.log"
    echo -e "Date Started:\t$(date +%Y-%m-%d-%R)" >> "${output_dir}/sag_awe.log"
    echo -e "Location:\t$HOSTNAME" >> "${output_dir}/sag_awe.log"
    echo -e "Command:\t${0} ${ARGS}" >> "${output_dir}/sag_awe.log"
    echo -e "Individual logs for each step are located in their respective folder." >> "${output_dir}/sag_awe.log"
}

#
# Workflow Variables
#
ARGS=( "$@" )
ASSEMBLY="contigs.fasta"
BUSCO_LINEAGES="eukaryota_odb9"
MERGED="false"
NCBI_DB=""
NORMALISED="false"
NUMARGS=$#
OUTDIR="output_sagawe"
QUAST_SCAFFOLDS=""
READ1=""
READ2=""
THREADS=$(cores)
TAXDB=""

if [ "${NUMARGS}" -eq 0 ]; then
    help_message
fi

#
# Getopts Workflow
#
while getopts "f:r:o:tnmsqScb:B:T:h" FLAG; do
    case "${FLAG}" in
        f)
            READ1="${OPTARG}"
	    ;;
        r)
            READ2="${OPTARG}"
            ;;
        o)
            OUTDIR="${OPTARG}"
	    mkdir -p "${OUTDIR}"
            cite_log "${OUTDIR}"
            ;;
        t)
            run_trim_galore "${OUTDIR}"
            ;;
        n)
            run_normalisation "${OUTDIR}"
            NORMALISED="true"
            ;;
        m)
            run_bbmerge "${OUTDIR}"
            MERGED="true"
            ;;
        s)
            run_assembly_spades "${OUTDIR}"
            ;;
        q)
            assembly_type=$(get_assembly_type)
            report_quast_v4 "${OUTDIR}" "${assembly_type}"
            ;;
        S)
            ASSEMBLY="scaffolds.fasta"
            QUAST_SCAFFOLDS="-s"
            ;;
        c)
            assembly_type=$(get_assembly_type)
            report_cegma "${OUTDIR}" "${assembly_type}"
            ;;
        b)
            BUSCO_LINEAGES="${OPTARG}"
            assembly_type=$(get_assembly_type)
            report_busco_v3 "${OUTDIR}" "${assembly_type}"
            ;;
        B)
            NCBI_DB="${OPTARG}"
            assembly_type=$(get_assembly_type)
            report_blobtools "${OUTDIR}" "${assembly_type}" "${NCBI_DB}"
            ;;
        h)
            help_message
	    ;;
        \?)
	    help_message
            ;;
    esac
done

if [ ! "${OUTDIR}" ]; then
    echo "No output directory set. Please indicate -o" >&2
    exit 1
fi

output_dir="$( cd "${OUTDIR}" && pwd )"
echo -e "Date Finished:\t$(date +%Y-%m-%d-%R)" >> "${output_dir}/sag_awe.log"
exit 0
